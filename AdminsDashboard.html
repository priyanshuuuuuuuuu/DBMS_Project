<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | FoodLoop</title>
    <link rel="stylesheet" href="style/adminDashboard.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css">
    <meta name="robots" content="noindex, nofollow">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar Navigation -->
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <div class="logo">FoodLoop</div>
                <div class="admin-badge">Admin</div>
            </div>
            <div class="admin-info">
                <div class="admin-img">
                    <img src="Assets/Images/admin-profile.jpg" alt="Admin Profile">
                </div>
                <div class="admin-details">
                    <h3>Admin Panel</h3>
                    <p>System Administrator</p>
                </div>
            </div>
            <nav class="admin-nav">
                <ul>
                    <li class="active"><a href="#dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li><a href="#users"><i class="fas fa-users"></i> User Management</a></li>
                    <li>
                        <a href="#transactions" class="dropdown-toggle"><i class="fas fa-exchange-alt"></i> Transactions <i class="fas fa-chevron-down"></i></a>
                        <ul class="submenu">
                            <li><a href="#pending">Pending</a></li>
                            <li><a href="#completed">Completed</a></li>
                            <li><a href="#failed">Failed</a></li>
                        </ul>
                    </li>
                    <li><a href="#listings"><i class="fas fa-list"></i> Waste Listings</a></li>
                    <li><a href="providerlist.html"><i class="fas fa-store"></i> Food Providers</a></li>
                    <li><a href="companiesList.html"><i class="fas fa-industry"></i> Waste Processors</a></li>
                    <li><a href="transporterelist.html"><i class="fas fa-truck"></i> Transporters</a></li>
                    <li><a href="#reports"><i class="fas fa-chart-bar"></i> Reports</a></li>
                    <li><a href="#settings"><i class="fas fa-cog"></i> System Settings</a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a href="MainPage.html" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="admin-content">
            <header class="admin-header">
                <div class="header-left">
                    <button class="toggle-sidebar">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h2>Dashboard</h2>
                </div>
                <div class="header-right">
                    <div class="search-container">
                        <input type="text" placeholder="Search...">
                        <button><i class="fas fa-search"></i></button>
                    </div>
                    <div class="admin-notifications">
                        <i class="fas fa-bell"></i>
                        <span class="notification-count">7</span>
                        <div class="notifications-dropdown">
                            <div class="notifications-header">
                                <h3>Notifications</h3>
                                <button class="mark-all-read">Mark all as read</button>
                            </div>
                            <div class="notifications-list">
                                <div class="notification-item unread">
                                    <div class="notification-icon system">
                                        <i class="fas fa-exclamation-circle"></i>
                                    </div>
                                    <div class="notification-content">
                                        <p class="notification-text">System alert: High server load detected</p>
                                        <p class="notification-time">10 minutes ago</p>
                                    </div>
                                </div>
                                <div class="notification-item unread">
                                    <div class="notification-icon user">
                                        <i class="fas fa-user-plus"></i>
                                    </div>
                                    <div class="notification-content">
                                        <p class="notification-text">New user registration: <strong>GreenTech Inc.</strong></p>
                                        <p class="notification-time">45 minutes ago</p>
                                    </div>
                                </div>
                                <div class="notification-item unread">
                                    <div class="notification-icon reports">
                                        <i class="fas fa-flag"></i>
                                    </div>
                                    <div class="notification-content">
                                        <p class="notification-text">New content reported for review</p>
                                        <p class="notification-time">2 hours ago</p>
                                    </div>
                                </div>
                                <div class="notification-item">
                                    <div class="notification-icon transaction">
                                        <i class="fas fa-exchange-alt"></i>
                                    </div>
                                    <div class="notification-content">
                                        <p class="notification-text">Transaction failed: ID #TRX-8842</p>
                                        <p class="notification-time">Yesterday</p>
                                    </div>
                                </div>
                            </div>
                            <div class="notifications-footer">
                                <a href="#all-notifications">View all notifications</a>
                            </div>
                        </div>
                    </div>
                    <div class="admin-profile">
                        <img src="Assets/Images/admin-profile.jpg" alt="Admin">
                        <span>Admin</span>
                        <i class="fas fa-chevron-down"></i>
                        <div class="admin-dropdown">
                            <a href="#profile"><i class="fas fa-user-circle"></i> My Profile</a>
                            <a href="#settings"><i class="fas fa-cog"></i> Settings</a>
                            <a href="MainPage.html"><i class="fas fa-sign-out-alt"></i> Logout</a>
                        </div>
                    </div>
                </div>
            </header>

            <div class="dashboard-wrapper">
                <!-- Overview Stats -->
                <section class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-icon users">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-details">
                            <h3>Total Users</h3>
                            <p class="stat-value" id="totalUsersCount">0</p>
                            <p class="stat-change positive"><i class="fas fa-arrow-up"></i> 0% this month</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon providers">
                            <i class="fas fa-store"></i>
                        </div>
                        <div class="stat-details">
                            <h3>Food Providers</h3>
                            <p class="stat-value" id="providersCount">0</p>
                            <p class="stat-change positive"><i class="fas fa-arrow-up"></i> 0% this month</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon processors">
                            <i class="fas fa-industry"></i>
                        </div>
                        <div class="stat-details">
                            <h3>Waste Processors</h3>
                            <p class="stat-value" id="companiesCount">0</p>
                             <p class="stat-change positive"><i class="fas fa-arrow-up"></i> 0% this month</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon transporters">
                            <i class="fas fa-truck"></i>
                        </div>
                        <div class="stat-details">
                            <h3>Transporters</h3>
                            <p class="stat-value" id="transportersCount">0</p>
                             <p class="stat-change positive"><i class="fas fa-arrow-up"></i> 0% this month</p>
                        </div>
                    </div>
                </section>

                <!-- Activity & Performance -->
                <section class="dashboard-grid">
                    <!-- Transaction Summary -->
                    <div class="dashboard-card transaction-summary">
                        <div class="card-header">
                            <h3><i class="fas fa-exchange-alt"></i> Transaction Summary</h3>
                            <div class="card-actions">
                                <select>
                                    <option>Last 7 Days</option>
                                    <option>Last 30 Days</option>
                                    <option>Last 90 Days</option>
                                </select>
                                <button class="refresh-btn"><i class="fas fa-sync-alt"></i></button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="transactionsChart"></canvas>
                            </div>
                        </div>
                    </div>


                    <div class="dashboard-card assign-transporters">
                        <div class="card-header">
                            <h3><i class="fas fa-truck"></i> Assign Transporters</h3>
                        </div>
                        <div class="card-body">
                            <div class="assign-transporters-grid" id="assignTransportersGrid">
                                <!-- Cards will be dynamically populated -->
                            </div>
                        </div>
                    </div>

                    <!-- System Performance -->
                    <div class="dashboard-card system-performance">
                        <div class="card-header">
                            <h3><i class="fas fa-chart-line"></i> System Performance</h3>
                            <div class="card-actions">
                                <button class="refresh-btn"><i class="fas fa-sync-alt"></i></button>
                                <button class="more-btn"><i class="fas fa-ellipsis-v"></i></button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="performance-metric">
                                <div class="metric-header">
                                    <h4>Server Load</h4>
                                    <span class="metric-value">42%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress" style="width: 42%"></div>
                                </div>
                            </div>

                            <div class="performance-metric">
                                <div class="metric-header">
                                    <h4>Memory Usage</h4>
                                    <span class="metric-value">65%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress warning" style="width: 65%"></div>
                                </div>
                            </div>

                            <div class="performance-metric">
                                <div class="metric-header">
                                    <h4>API Response Time</h4>
                                    <span class="metric-value">182ms</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress success" style="width: 30%"></div>
                                </div>
                            </div>

                            <div class="performance-metric">
                                <div class="metric-header">
                                    <h4>Database Queries</h4>
                                    <span class="metric-value">2,845/min</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress" style="width: 55%"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Activity -->
                    <div class="dashboard-card user-activity">
                        <div class="card-header">
                            <h3><i class="fas fa-users"></i> User Activity</h3>
                            <div class="card-actions">
                                <select>
                                    <option>All Users</option>
                                    <option>Providers</option>
                                    <option>Processors</option>
                                    <option>Transporters</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="activity-feed">
                                <div class="activity-item">
                                    <div class="activity-icon"><i class="fas fa-user-plus"></i></div>
                                    <div class="activity-content">
                                        <p><strong>GreenTech Inc.</strong> registered as a new processor</p>
                                        <span class="activity-time">15 minutes ago</span>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon"><i class="fas fa-list"></i></div>
                                    <div class="activity-content">
                                        <p><strong>Sunrise Cafe</strong> created a new waste listing</p>
                                        <span class="activity-time">45 minutes ago</span>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon"><i class="fas fa-truck"></i></div>
                                    <div class="activity-content">
                                        <p><strong>EcoLogistics</strong> completed a waste delivery</p>
                                        <span class="activity-time">1 hour ago</span>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon"><i class="fas fa-exchange-alt"></i></div>
                                    <div class="activity-content">
                                        <p><strong>BioFuel Corp.</strong> processed a payment of ₹13,500</p>
                                        <span class="activity-time">2 hours ago</span>
                                    </div>
                                </div>
                                <div class="activity-item">
                                    <div class="activity-icon"><i class="fas fa-edit"></i></div>
                                    <div class="activity-content">
                                        <p><strong>Grand Hotel</strong> updated their business profile</p>
                                        <span class="activity-time">3 hours ago</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Listings -->
                    <div class="dashboard-card recent-listings">
                        <div class="card-header">
                            <h3><i class="fas fa-list"></i> Recent Waste Listings</h3>
                            <div class="card-actions">
                                <a href="#view-all-listings" class="view-all">View All</a>
                            </div>
                        </div>
                        <div class="card-body">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Provider</th>
                                        <th>Waste Type</th>
                                        <th>Quantity</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>#LST-2845</td>
                                        <td>Green Canteen</td>
                                        <td>Vegetable Scraps</td>
                                        <td>45 kg</td>
                                        <td><span class="status available">Available</span></td>
                                        <td>
                                            <div class="action-buttons">
                                                <button class="action-btn view"><i class="fas fa-eye"></i></button>
                                                <button class="action-btn edit"><i class="fas fa-edit"></i></button>
                                                <button class="action-btn delete"><i class="fas fa-trash-alt"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>#LST-2844</td>
                                        <td>Royal Hotel</td>
                                        <td>Used Cooking Oil</td>
                                        <td>60 kg</td>
                                        <td><span class="status pending">Pending</span></td>
                                        <td>
                                            <div class="action-buttons">
                                                <button class="action-btn view"><i class="fas fa-eye"></i></button>
                                                <button class="action-btn edit"><i class="fas fa-edit"></i></button>
                                                <button class="action-btn delete"><i class="fas fa-trash-alt"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>#LST-2843</td>
                                        <td>Campus Dining</td>
                                        <td>Mixed Food Waste</td>
                                        <td>120 kg</td>
                                        <td><span class="status processing">Processing</span></td>
                                        <td>
                                            <div class="action-buttons">
                                                <button class="action-btn view"><i class="fas fa-eye"></i></button>
                                                <button class="action-btn edit"><i class="fas fa-edit"></i></button>
                                                <button class="action-btn delete"><i class="fas fa-trash-alt"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>#LST-2842</td>
                                        <td>Sunrise Cafe</td>
                                        <td>Coffee Grounds</td>
                                        <td>18 kg</td>
                                        <td><span class="status available">Available</span></td>
                                        <td>
                                            <div class="action-buttons">
                                                <button class="action-btn view"><i class="fas fa-eye"></i></button>
                                                <button class="action-btn edit"><i class="fas fa-edit"></i></button>
                                                <button class="action-btn delete"><i class="fas fa-trash-alt"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Pending Approvals -->
                    <div class="dashboard-card pending-approvals">
                        <div class="card-header">
                            <h3><i class="fas fa-clock"></i> Pending Approvals</h3>
                        </div>
                        <div class="card-body">
                            <div class="approval-stats">
                                <div class="approval-stat">
                                    <div class="approval-icon users">
                                        <i class="fas fa-user-check"></i>
                                    </div>
                                    <div class="approval-details">
                                        <h4>User Verifications</h4>
                                        <p>12</p>
                                    </div>
                                </div>
                                <div class="approval-stat">
                                    <div class="approval-icon listings">
                                        <i class="fas fa-clipboard-check"></i>
                                    </div>
                                    <div class="approval-details">
                                        <h4>Listing Reviews</h4>
                                        <p>24</p>
                                    </div>
                                </div>
                                <div class="approval-stat">
                                    <div class="approval-icon reports">
                                        <i class="fas fa-flag"></i>
                                    </div>
                                    <div class="approval-details">
                                        <h4>Content Reports</h4>
                                        <p>7</p>
                                    </div>
                                </div>
                            </div>
                            <button class="approval-btn">Review All Pending Items</button>
                        </div>
                    </div>
                    
                    <!-- Environmental Impact -->
                    <div class="dashboard-card environmental-impact">
                        <div class="card-header">
                            <h3><i class="fas fa-leaf"></i> Environmental Impact</h3>
                            <div class="card-actions">
                                <select>
                                    <option>This Month</option>
                                    <option>This Quarter</option>
                                    <option>This Year</option>
                                </select>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="impact-metrics">
                                <div class="impact-metric">
                                    <div class="impact-icon waste"><i class="fas fa-recycle"></i></div>
                                    <div class="impact-details">
                                        <h4>Waste Diverted</h4>
                                        <p>24,750 kg</p>
                                    </div>
                                </div>
                                <div class="impact-metric">
                                    <div class="impact-icon co2"><i class="fas fa-cloud"></i></div>
                                    <div class="impact-details">
                                        <h4>CO₂ Emissions Saved</h4>
                                        <p>52,345 kg</p>
                                    </div>
                                </div>
                                <div class="impact-metric">
                                    <div class="impact-icon water"><i class="fas fa-tint"></i></div>
                                    <div class="impact-details">
                                        <h4>Water Saved</h4>
                                        <p>1.2M liters</p>
                                    </div>
                                </div>
                            </div>
                            <div class="chart-container">
                                <canvas id="impactChart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
     <script src="js/script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Toggle sidebar
            document.querySelector('.toggle-sidebar').addEventListener('click', function() {
                document.querySelector('.admin-container').classList.toggle('sidebar-collapsed');
            });

            // Submenu toggle
            document.querySelectorAll('.dropdown-toggle').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    this.parentNode.classList.toggle('active');
                });
            });

            // Admin profile dropdown
            document.querySelector('.admin-profile').addEventListener('click', function(e) {
                e.stopPropagation();
                this.querySelector('.admin-dropdown').classList.toggle('active');
            });

            // Notifications dropdown
            document.querySelector('.admin-notifications').addEventListener('click', function(e) {
                e.stopPropagation();
                this.querySelector('.notifications-dropdown').classList.toggle('active');
            });

            // Close dropdowns when clicking elsewhere
            document.addEventListener('click', function(e) {
                document.querySelectorAll('.admin-dropdown, .notifications-dropdown').forEach(dropdown => {
                    if (!dropdown.parentNode.contains(e.target)) {
                        dropdown.classList.remove('active');
                    }
                });
            });

            // Transactions Chart
            const transactionsCtx = document.getElementById('transactionsChart').getContext('2d');
            const transactionsChart = new Chart(transactionsCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [
                        {
                            label: 'Successful',
                            data: [32, 45, 38, 52, 48, 65, 70],
                            backgroundColor: 'rgba(40, 167, 69, 0.2)',
                            borderColor: '#28a745',
                            borderWidth: 2,
                            tension: 0.4
                        },
                        {
                            label: 'Failed',
                            data: [8, 5, 10, 4, 7, 3, 2],
                            backgroundColor: 'rgba(220, 53, 69, 0.2)',
                            borderColor: '#dc3545',
                            borderWidth: 2,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // Environmental Impact Chart
            const impactCtx = document.getElementById('impactChart').getContext('2d');
            const impactChart = new Chart(impactCtx, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Waste Processed (kg)',
                        data: [3520, 3980, 4250, 3800, 4100, 5000],
                        backgroundColor: 'rgba(21, 56, 24, 0.7)',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Add logout functionality that also clears admin authentication
            document.querySelectorAll('.logout-btn, .admin-dropdown a[href="MainPage.html"]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    // Clear admin authentication
                    localStorage.removeItem('adminAuth');
                    window.location.href = 'MainPage.html';
                });
            });
        });

        
 
        const assignTransportersGrid = document.getElementById('assignTransportersGrid');
 
 // Fetch and populate the Assign Transporters section
 async function loadAssignTransporters() {
     try {
         const response = await fetch('http://localhost:3000/api/waste-requests');
         const data = await response.json();

         assignTransportersGrid.innerHTML = ''; // Clear existing cards

         data.forEach(request => {
             const card = document.createElement('div');
             card.classList.add('assign-card');
             card.innerHTML = `
                 <div class="assign-card-header">
                     <h4>Request ID: ${request.request_id}</h4>
                 </div>
                 <div class="assign-card-body">
                     <p><strong>Company:</strong> ${request.contact_person_name}</p>
                     <p><strong>Provider:</strong> ${request.name}</p>
                     <p><strong>Waste Type:</strong> ${request.WasteType}</p>
                     <p><strong>Quantity:</strong> ${request.quantity} kg</p>
                     <div class="assign-action">
                         <select class="transporter-select" data-request-id="${request.request_id}">
                             <option value="" disabled selected>Select Transporter</option>
                             <!-- Transporter options will be dynamically populated -->
                         </select>
                         <button class="assign-btn" data-request-id="${request.request_id}">Assign</button>
                     </div>
                 </div>
             `;
             assignTransportersGrid.appendChild(card);
         });

         // Populate transporter options
         const transporterResponse = await fetch('http://localhost:3000/api/transporters');
         const transporters = await transporterResponse.json();

         document.querySelectorAll('.transporter-select').forEach(select => {
             transporters.forEach(transporter => {
                 const option = document.createElement('option');
                 option.value = transporter.transporter_id;
                 option.textContent = transporter.name;
                 select.appendChild(option);
             });
         });

         // Add event listeners to "Assign" buttons
         document.querySelectorAll('.assign-btn').forEach(button => {
             button.addEventListener('click', function () {
                 const requestId = this.getAttribute('data-request-id');
                 const transporterId = this.previousElementSibling.value;

                 if (!transporterId) {
                     alert('Please select a transporter.');
                     return;
                 }

                 assignTransporter(requestId, transporterId);
             });
         });
     } catch (error) {
         console.error('Error loading assign transporters:', error);
     }
 }

 // Assign a transporter to a waste request
 async function assignTransporter(requestId, transporterId) {
     try {
         const response = await fetch('http://localhost:3000/api/assign-transporter', {
             method: 'POST',
             headers: {
                 'Content-Type': 'application/json',
             },
             body: JSON.stringify({ requestId, transporterId }),
         });

         const result = await response.json();

         if (response.ok) {
             alert('Transporter assigned successfully!');
             loadAssignTransporters(); // Refresh the section
         } else {
             alert(`Failed to assign transporter: ${result.message}`);
         }
     } catch (error) {
         console.error('Error assigning transporter:', error);
         alert('An error occurred while assigning the transporter.');
     }
 }

 loadAssignTransporters();

document.addEventListener('DOMContentLoaded', async function () {
 try {
     const response = await fetch('http://localhost:3000/api/dashboard-stats');
     const stats = await response.json();

     document.getElementById('totalUsersCount').textContent = stats.totalUsers || 0;
     document.getElementById('providersCount').textContent = stats.providers || 0;
     document.getElementById('companiesCount').textContent = stats.companies || 0;
     document.getElementById('transportersCount').textContent = stats.transporters || 0;
 } catch (error) {
     console.error('Error fetching dashboard stats:', error);
 }
});
    </script>
</body>
</html>
